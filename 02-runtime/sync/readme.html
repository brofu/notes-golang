
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Sync Â· Brofu's Talk</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../../03-programming_paradigms/readme.html" />
    
    
    <link rel="prev" href="../31-gc/02-tools.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../../01-specification/readme.html">
            
                <a href="../../01-specification/readme.html">
            
                    
                    Specification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../../01-specification/01-slice/readme.html">
            
                <a href="../../01-specification/01-slice/readme.html">
            
                    
                    Slice
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../../01-specification/01-slice/01-understand_two_addresses.html">
            
                <a href="../../01-specification/01-slice/01-understand_two_addresses.html">
            
                    
                    Understand Two Addresses
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../../01-specification/02-interface/readme.html">
            
                <a href="../../01-specification/02-interface/readme.html">
            
                    
                    Interface
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../../01-specification/02-interface/001-empty-and-non-empty-interface.html">
            
                <a href="../../01-specification/02-interface/001-empty-and-non-empty-interface.html">
            
                    
                    Empty And Non Empty Interface
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="../../01-specification/02-interface/200-delegation-pattern.html">
            
                <a href="../../01-specification/02-interface/200-delegation-pattern.html">
            
                    
                    Delegation Pattern
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../../01-specification/03-struct/readme.html">
            
                <a href="../../01-specification/03-struct/readme.html">
            
                    
                    Struct
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="../../01-specification/03-struct/01-understand_empty_struct.html">
            
                <a href="../../01-specification/03-struct/01-understand_empty_struct.html">
            
                    
                    Understand Empty Struct
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="../../01-specification/03-struct/02-field-alignment.html">
            
                <a href="../../01-specification/03-struct/02-field-alignment.html">
            
                    
                    Field Alignment
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../../01-specification/generics.html">
            
                <a href="../../01-specification/generics.html">
            
                    
                    Generics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../readme.html">
            
                <a href="../readme.html">
            
                    
                    Runtime
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../31-gc/readme.html">
            
                <a href="../31-gc/readme.html">
            
                    
                    Gc
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../31-gc/00-principles.html">
            
                <a href="../31-gc/00-principles.html">
            
                    
                    Principles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../31-gc/01-code.html">
            
                <a href="../31-gc/01-code.html">
            
                    
                    Code
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="../31-gc/02-tools.html">
            
                <a href="../31-gc/02-tools.html">
            
                    
                    Tools
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter active" data-level="1.3.2" data-path="readme.html">
            
                <a href="readme.html">
            
                    
                    Sync
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../../03-programming_paradigms/readme.html">
            
                <a href="../../03-programming_paradigms/readme.html">
            
                    
                    Programming Paradigms
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../../04-engineering/readme.html">
            
                <a href="../../04-engineering/readme.html">
            
                    
                    Engineering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../../05-interviews/readme.html">
            
                <a href="../../05-interviews/readme.html">
            
                    
                    Interviews
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Sync</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="synconce">sync.Once</h2>
<h4 id="source-code">Source Code</h4>
<pre><code>type Once struct {
    done uint32
    m    Mutex
}

func (o *Once) Do(f func()) {
    if atomic.LoadUint32(&amp;o.done) == 0 { 
        o.doSlow(f)
    }
}

func (o *Once) doSlow(f func()) {
    o.m.Lock()
    defer o.m.Unlock()
    if o.done == 0 {
        defer atomic.StoreUint32(&amp;o.done, 1)
        f()
    }
}
</code></pre><h4 id="key-points">Key Points</h4>
<ol>
<li>A Once must not be copied after first use. Since <code>defer atomic.StoreUint32(&amp;o.done, 1)</code> would update <code>o.done</code> by address</li>
<li>Why <code>done</code> is the first?    <ul>
<li>`It is first in the struct because it is used in the hot path. The hot path is inlined at every call site. Placing done first allows more compact instructions on some architectures (amd64/386), and fewer instructions (to calculate offset) on other architectures.</li>
<li>In short, <code>o.done</code> is high frequently accessed, put it first would make the performance better. </li>
</ul>
</li>
<li>Pay attention to <code>Deadlock</code>. Because no call to Do returns until the one call to f returns, if f causes Do to be called, it will deadlock.</li>
<li>About <code>panic</code>. If f panics, Do considers it to have returned; future calls of Do return without calling f. =&gt; How? </li>
<li><p>Wrong version of <code>Once.Do</code>. Why?</p>
<pre><code>if atomic.CompareAndSwapUint32(&amp;o.done, 0, 1) {
 f()
}
</code></pre><blockquote>
<p>Do guarantees that when it returns, f has finished. This implementation would not implement that guarantee:
 given two simultaneous calls, the winner of the cas would call f, and the second would return immediately, without waiting for the first&apos;s call to f to complete.
 This is why the slow path falls back to a mutex, and why the atomic.StoreUint32 must be delayed until after f returns.</p>
</blockquote>
<p>In short, <code>CAS</code> would return at immediately, but lock would block the call.</p>
</li>
</ol>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="../31-gc/02-tools.html" class="navigation navigation-prev " aria-label="Previous page: Tools">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../../03-programming_paradigms/readme.html" class="navigation navigation-next " aria-label="Next page: Programming Paradigms">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Sync","level":"1.3.2","depth":2,"next":{"title":"Programming Paradigms","level":"1.4","depth":1,"path":"03-programming_paradigms/readme.md","ref":"03-programming_paradigms/readme.md","articles":[]},"previous":{"title":"Tools","level":"1.3.1.3","depth":3,"path":"02-runtime/31-gc/02-tools.md","ref":"02-runtime/31-gc/02-tools.md","articles":[]},"dir":"ltr"},"config":{"plugins":["plantuml-cloud","disqus"],"styles":{"pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css","website":"styles/website.css"},"pluginsConfig":{"plantuml-cloud":{"umlPath":"images/uml","protocol":"http","type":"plantuml-server","host":"www.plantuml.com","port":"80","path":"/plantuml/svg"},"disqus":{"useIdentifier":false,"shortName":"brofu-tech"},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css","website":"styles/website.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"sortedBy":"-","variables":{},"title":"Brofu's Talk","gitbook":"*"},"file":{"path":"02-runtime/sync/readme.md","mtime":"2025-10-04T01:39:04.512Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2025-10-04T01:39:45.672Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

